# Архитектура системы

## Обзор системы

Fast Ray Gram - это распределенная система для управления конфигурациями, построенная на микросервисной архитектуре. Система состоит из четырех основных сервисов, работающих в контейнерах Docker, и использует общую базу данных PostgreSQL и Redis для кэширования и rate limiting.

Архитектура системы следует принципам разделения ответственности: каждый сервис выполняет свою специфическую функцию и взаимодействует с другими через четко определенные интерфейсы (HTTP API, база данных).

Подробное описание взаимодействия сервисов см. в [документации по сервисам](services.md).

## Компоненты системы

### Backend API

FastAPI приложение, предоставляющее REST API для всех операций системы. Является центральным компонентом, обрабатывающим бизнес-логику, аутентификацию, авторизацию и управление данными.

**Основные функции:**
- REST API для управления пользователями, конфигурациями, сессиями
- JWT-базированная аутентификация и авторизация
- Интеграция с 3X-UI для синхронизации VPN конфигураций
- Административные функции для управления системой

**Технологии:** FastAPI, SQLAlchemy, asyncpg, Redis, JWT

Подробное описание см. в [документации по сервисам](services.md#backend-api-service). API endpoints описаны в [API документации](api.md). Аутентификация и авторизация описаны в [документации по аутентификации](authentication.md).

### Frontend

React приложение на TypeScript, предоставляющее пользовательский интерфейс. Собирается в статические файлы и обслуживается через Nginx.

**Основные функции:**
- Пользовательский интерфейс для управления конфигурациями
- Административная панель для управления системой
- Интеграция с Telegram WebApp для авторизации через Telegram
- Многоязычность (русский/английский)

**Технологии:** React, TypeScript, Vite, Zustand, React Router

Подробное описание см. в [документации по сервисам](services.md#frontend-service).

### Notificator Service

Фоновый Python сервис, работающий в цикле и обрабатывающий уведомления пользователям.

**Основные функции:**
- Проверка истекающих конфигураций и создание уведомлений
- Отправка уведомлений через Telegram и другие каналы
- Очистка старых уведомлений

**Технологии:** Python, asyncpg, aiogram

Подробное описание см. в [документации по сервисам](services.md#notificator-service).

### Telegram Bot

Простой Telegram бот на aiogram, предоставляющий точку входа в веб-приложение через Telegram WebApp.

**Основные функции:**
- Команда `/start` для открытия веб-приложения
- Интеграция с Telegram WebApp API

**Технологии:** Python, aiogram

Подробное описание см. в [документации по сервисам](services.md#telegram-bot-service).

## Инфраструктура

### База данных (PostgreSQL)

PostgreSQL используется как основное хранилище данных для всех сервисов. Все сервисы работают с единой схемой базы данных.

**Использование:**
- **Backend**: основная работа с БД через SQLAlchemy ORM
- **Notificator**: прямое подключение через asyncpg для чтения/записи уведомлений

**Модели данных:**
- Пользователи и профили (`user`, `role`, `profile`, `social`)
- Сессии и токены (`session`, `refresh`)
- Конфигурации VPN (`config`)
- Уведомления (`notification`)
- Запросы (`request`)
- Новости (`news`)
- Настройки приложения (`app_settings`)

Подробное описание моделей данных см. в [документации по моделям данных](data-models.md). Взаимодействие с БД описано в [документации по сервисам](services.md#база-данных).

### Redis

Система использует два экземпляра Redis для различных целей:

1. **Основной Redis** - кэширование JWT токенов и данных сессий для быстрой валидации
2. **Redis Rate Limiter** - отслеживание количества запросов по IP-адресам для rate limiting

Подробное описание использования Redis см. в [документации по сервисам](services.md#взаимодействие-с-redis) и [документации по аутентификации](authentication.md).

### Docker и Docker Compose

Все сервисы развертываются в контейнерах Docker и управляются через Docker Compose. Это обеспечивает изоляцию сервисов, простоту развертывания и масштабирования.

**Структура:**
- Каждый сервис имеет свой Dockerfile
- Общая сеть `frg-network` для взаимодействия между контейнерами
- Общие volumes для персистентных данных (`/volumes`)
- Единый файл `.env` для конфигурации всех сервисов

Подробное описание развертывания см. в [руководстве пользователя](../userguide.md).

## Схема взаимодействия компонентов

Система использует несколько способов взаимодействия между компонентами:

1. **HTTP API** - основной способ взаимодействия Frontend с Backend
2. **База данных** - общее хранилище данных для Backend и Notificator
3. **Redis** - кэширование и rate limiting для Backend
4. **Telegram Bot API** - отправка уведомлений через Notificator

**Основные потоки:**
- Пользователь → Frontend → Backend → PostgreSQL/Redis
- Backend → 3X-UI (внешний сервис) для синхронизации конфигураций
- Notificator → PostgreSQL (чтение уведомлений) → Telegram Bot API (отправка)
- Telegram Bot → Frontend (через WebApp)

Подробные схемы взаимодействия описаны в [документации по сервисам](services.md#схемы-взаимодействия).

## Потоки данных

### Аутентификация и авторизация

1. Пользователь регистрируется/входит через Frontend
2. Frontend отправляет запрос на Backend API
3. Backend создает JWT токены и сохраняет их в Redis и БД
4. Frontend сохраняет токены и использует их для последующих запросов
5. Backend валидирует токены через Redis (быстро) или БД

Подробное описание потоков аутентификации см. в [документации по аутентификации](authentication.md).

### Управление конфигурациями

1. Пользователь создает конфигурацию через Backend API
2. Backend синхронизирует конфигурацию с 3X-UI
3. Backend сохраняет конфигурацию в БД
4. Пользователь видит конфигурацию через Frontend
5. Notificator периодически проверяет истекающие конфигурации и создает уведомления

### Отправка уведомлений

1. Backend создает уведомление в БД (например, при создании запроса)
2. Notificator периодически проверяет новые уведомления
3. Notificator отправляет уведомление через Telegram Bot API
4. Notificator обновляет статус отправки в БД

Подробное описание потоков данных см. в [документации по сервисам](services.md#схемы-взаимодействия). API endpoints описаны в [API документации](api.md).
